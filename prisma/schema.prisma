generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String            @id @default(cuid())
  email           String            @unique
  name            String?
  password        String?
  role            String            @default("user")
  isBanned        Boolean           @default(false)
  subscription    Subscription?
  savedArticles   SavedArticle[]
  readingProgress ReadingProgress[]
  sessions        Session[]
  auditLogs       AuditLog[]
  payments        Payment[]
  paymentConsents PaymentConsent[]
  issueReviews    IssueArticle[]    @relation("IssueArticleReviewer")
  authorProfile   AuthorProfile?    @relation("UserAuthorProfile")
  createdAt       DateTime          @default(now())
}

model Subscription {
  id        String   @id @default(cuid())
  userId    String   @unique
  plan      String
  status    String
  expiresAt DateTime
  stripeId  String?
  user      User     @relation(fields: [userId], references: [id])
}

model Category {
  id       String    @id @default(cuid())
  name     String
  slug     String    @unique
  order    Int       @default(0)
  parentId String?
  parent   Category? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  articles Article[]
}

model Article {
  id         String   @id @default(cuid())
  title      String
  slug       String   @unique
  content    String   @db.Text
  coverUrl   String?
  audioUrl   String?
  status     String   @default("draft")
  publishedAt DateTime?
  isPaywalled Boolean @default(false)
  isFeatured  Boolean @default(false)
  isRecommended Boolean @default(false)
  excerpt    String?
  metaTitle  String?
  metaDescription String?
  authorId   String?
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])
  author     AuthorProfile? @relation(fields: [authorId], references: [id])
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  saved      SavedArticle[]
  progress   ReadingProgress[]
  issueLinks IssueArticle[]
}

model SavedArticle {
  id        String  @id @default(cuid())
  userId    String
  articleId String
  user      User    @relation(fields: [userId], references: [id])
  article   Article @relation(fields: [articleId], references: [id])

  @@unique([userId, articleId])
}

model ReadingProgress {
  id        String   @id @default(cuid())
  userId    String
  articleId String
  progress  Int
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])
  article   Article  @relation(fields: [articleId], references: [id])

  @@unique([userId, articleId])
}

model Issue {
  id        String  @id @default(cuid())
  month     Int
  year      Int
  pdfUrl    String
  coverUrl  String?
  createdAt DateTime @default(now())
  articles  IssueArticle[]

  @@unique([year, month])
}

model IssueArticle {
  id         String   @id @default(cuid())
  issueId    String
  articleId  String
  reviewerId String?
  role       String   @default("author")
  order      Int      @default(0)
  issue      Issue    @relation(fields: [issueId], references: [id])
  article    Article  @relation(fields: [articleId], references: [id])
  reviewer   User?    @relation("IssueArticleReviewer", fields: [reviewerId], references: [id])

  @@unique([issueId, articleId])
}

model AuthorProfile {
  id         String    @id @default(cuid())
  name       String
  slug       String    @unique
  bio        String?
  avatarUrl  String?
  website    String?
  instagram  String?
  twitter    String?
  isListed   Boolean   @default(true)
  articles   Article[]
  createdAt  DateTime  @default(now())
  userId     String?   @unique
  user       User?     @relation("UserAuthorProfile", fields: [userId], references: [id])
}

model HomepageContent {
  id                         String   @id @default(cuid())
  heroBadge                  String?
  heroTitle                  String
  heroAccent                 String?
  heroDescription            String
  heroPrimaryCtaLabel         String
  heroPrimaryCtaHref          String
  heroSecondaryCtaLabel       String?
  heroSecondaryCtaHref        String?
  heroImageUrl               String?
  heroImageAlt               String?
  recommendationsTitle       String
  recommendationsDescription String?
  updatedAt                  DateTime @updatedAt
}

model CorporateContent {
  id        String   @id @default(cuid())
  content   Json
  updatedAt DateTime @updatedAt
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  expiresAt DateTime
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  targetType String
  targetId   String?
  metadata   Json?
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id])
}

model Payment {
  id               String   @id @default(cuid())
  userId           String
  plan             String
  status           String
  provider         String
  paymentModel     String
  amount           Int
  currency         String
  quantity         Int      @default(1)
  orderId          String
  remoteOrderId    String?
  transactionId    String?
  authCode         String?
  refRetNum        String?
  batchNum         String?
  installmentCount Int?
  cardMasked       String?
  cardType         String?
  responseCode     String?
  responseMessage  String?
  ipAddress        String?
  userAgent        String?
  billing          Json?
  authResponse     Json?
  paymentResponse  Json?
  statusResponse   Json?
  refundResponse   Json?
  cancelResponse   Json?
  refundedAmount   Int?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id])
  consents         PaymentConsent[]
}

model PaymentConsent {
  id              String   @id @default(cuid())
  paymentId       String
  userId          String
  type            String
  documentUrl     String?
  documentVersion String?
  acceptedAt      DateTime @default(now())
  ipAddress       String?
  userAgent       String?
  metadata        Json?
  payment         Payment  @relation(fields: [paymentId], references: [id])
  user            User     @relation(fields: [userId], references: [id])
}
